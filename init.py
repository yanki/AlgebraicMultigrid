import sys, os, shutil, json
import networkx as nx
import matplotlib.pyplot as plt
sys.path.insert(0, 'src')
from alg_methods import AlgebraicMultigrid as AM
from networkx import NetworkXError
from networkx.readwrite import json_graph

__author__ = """\n""".join(['Ilya Safro <isafro@g.clemson.edu>',
                            'Mikita Yankouski <myankou@g.clemson.edu>',
                            'Tiffany Verkaik <tverkai@g.clemson.edu>'])

def readMesh(graph_type):
    edge_list = []
    G = nx.Graph(directed = False, multigraph = False)
    if graph_type == 'rmf':

        with open('graphs/native.rmf') as f:
            for index, line in enumerate(f.readlines()):
                values = line.split(' ')
                edge = (int(values[1]) - 1, int(values[2]) - 1)
                edge_list.append(edge)

        # G = nx.grid_2d_graph(len(edge_list), len(edge_list))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ))
        G.add_edges_from(edge_list, weight=1)

        for node in G.nodes():
        	G.node[node]['volume'] = 1
        return G

    elif graph_type == 'json':

        with open('graphs/sum_column.json') as data_file:
            data = json.load(data_file)

        for node in data["nodes"]:
            G.add_node(node["id"])
            G.node[node["id"]]["volume"] = node["volume"]

        for edge in data["links"]:
            G.add_edge(edge["source"], edge["target"])
            G[edge["source"]][edge["target"]]["weight"] = edge["weight"]
        return G

def DrawGraph(Graph):
    layout = nx.spring_layout(Graph, iterations=200)
    nx.draw(Graph, node_size=1, pos=layout, font_size=.3, font_color="blue",# layout="sfdp",
            # node_color='#A0CBE2', edge_color='#BB0000', 
            width=.2, linewidths=.2, edge_cmap=plt.cm.Blues, with_labels=True
        )
    plt.savefig("start_graph.pdf", # dpi=1500, facecolor='w', edgecolor='w', 
            format="PDF", # format="None", orientation='portrait', papertype=None, 
            transparent=False, bbox_inches=None, pad_inches=0.1
        )

G = readMesh(graph_type = 'json')
# DrawGraph(G)

if (G.is_directed() is True) or (G.is_multigraph() is True):
    raise NetworkXError("AlgebraicMultigrid is not defined for directed or multi graphs.")

elif (len(G.nodes()) == 0) or (len(G.edges()) == 0):
    raise NetworkXError("The graph does not contain either Nodes or Edges.")

else:
    folder = 'records'

    for the_file in os.listdir(folder):
        file_path = os.path.join(folder, the_file)

        try:
            if os.path.isfile(file_path):
                os.unlink(file_path)
            #elif os.path.isdir(file_path): shutil.rmtree(file_path)
        except Exception, e:
            print e    
    if os.path.isfile("iterations_schema.json"):
        os.unlink("iterations_schema.json")
    print "Successfully cleaned previous records."

    volumes = {}
    volumes["iterations"] = {}
    with open("iterations_schema.json", 'w') as outfile:
        json.dump(volumes, outfile)

    # for node in G.nodes():
    #     for self, neigh in G.edges(node):
    #         if neigh == node:
    #             print "SELF LOOP: " + str(node) + " " + str(neigh)
    #             print G[node][neigh]['weight']
    #     # sys.exit()
    # sys.exit()
    AM(G)
